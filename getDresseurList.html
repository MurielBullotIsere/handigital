<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Liste des dresseurs</title>
        <!-- Charger la bibliothèque d’icônes Font Awesome depuis un CDN (Cloudflare), 
             Avec vérification de sécurité (SRI) (integrity)
             Sans fuite de données (referrer + crossorigin)  -->
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
        integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="   
        crossorigin="anonymous" referrerpolicy="no-referrer" />

    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div id="toastContainer"></div>

    <div class="page-header">
        <h2>Liste des dresseurs</h2>

        <button class="create-btn" onclick="window.location.href=pageCreer">
            <i class="fa-solid fa-plus"></i>
            Créer un dresseur
        </button>
    </div>
    
    <table>
        <thead>
        <tr>
            <th>Nom</th>
            <th>Actions</th>
        </tr>
        </thead>
        <tbody id="objetsTableBody"></tbody>
    </table>

    <script>
        const API_BASE_URL = 'http://localhost:3000/api/dresseurs';
        const tbody = document.getElementById("objetsTableBody");

        const pageCreer = "createDresseur.html";
        const pageModifier = "editDresseur.html";
        const pageEditer = "getOneDresseur.html";
        
        const messageSupprime = "Dresseur supprimé avec succès !";
        const messageConfirmation = "Voulez-vous vraiment supprimer ce dresseur ?";
        const messageAucun = "Aucun dresseur trouvé.";
        const messageErreur = "Erreur lors du chargement des dresseurs";

        /**
         * Affiche un message de type toast (succès ou erreur)
         * @param {string} message - Le message à afficher
         * @param {string} [type="success"] - Le type du message (succès ou erreur)
         */
        function showToast(message, type = "success") {
            const container = document.getElementById("toastContainer");
            const toast = document.createElement("div");

            toast.className = "toast";
            if (type === "error") toast.classList.add("error");

            toast.textContent = message;
            container.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, 1000);
        }

        /**
         * Charge les données depuis le serveur et les affiche dans la page.
         * En cas d'erreur, un toast d'erreur est affiché.
         */
        async function loadData() {
            try {
                const dataResponse = await fetch(API_BASE_URL);
                const dataJson = await dataResponse.json();

                tbody.innerHTML = "";

                if (!Array.isArray(dataJson) || dataJson.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="4">${messageAucun}</td></tr>`;
                    return;
                }

                dataJson.forEach(item => {
                    const tr = document.createElement("tr");
                    tr.innerHTML = `
                        <td>${item.nom}</td>
                        <td>
                            <div class="actions">
                                <button class="action-btn view" data-id="${item._id}" data-action="view">
                                    <i class="fa-regular fa-eye"></i>
                                </button>
                                <button class="action-btn edit" data-id="${item._id}" data-action="edit">
                                    <i class="fa-regular fa-pen-to-square"></i>
                                </button>
                                <button class="action-btn delete" data-id="${item._id}" data-action="delete">
                                    <i class="fa-regular fa-trash-can"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (error) {
                showToast(messageErreur, "error");
            }
        }

        tbody.addEventListener("click", async (e) => {
            const btn = e.target.closest("button");
            if (!btn) return;

            const id = btn.dataset.id;
            const action = btn.dataset.action;

            if (action === "view") {
                window.location.href = `${pageEditer}?id=${id}`;

                return;
            }

            if (action === "edit") {
                window.location.href = `${pageModifier}?id=${id}`;
                return;
            }

            if (action === "delete") {
                if (!confirm(messageConfirmation)) return;

                try {
                    const dataResponse = await fetch(`${API_BASE_URL}/${id}`, {
                        method: "DELETE"
                    });

                    if (dataResponse.ok) {
                        showToast(messageSupprime);
                        loadData();
                    } else {
                        showToast("Erreur lors de la suppression", "error");
                    }
                } catch (error) {
                    showToast("Erreur serveur", "error");
                }
            }
        });

        loadData();

    </script>

</body>
</html>

