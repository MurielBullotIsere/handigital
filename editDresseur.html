<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Modifier un dresseur</title>
</head>
<body>

    <h2>Modifier un dresseur</h2>

    <form id="dresseurForm">                                        
        <label>Nom :</label><br>                                    <!-- Identifiant pour récupérer le formulaire dans le JavaScript. -->
        <input type="text" id="nom" required><br><br>               <!-- Champ où l’utilisateur saisit le nom. -->

        <!-- Liste des pokemons. -->
        <fieldset>
            <legend>Sélectionner zéro, un ou plusieurs Pokemons capturés :</legend>
            <div id="pokemonList"></div>                            <!-- Zone où on affichera dynamiquement des cases à cocher. -->
        </fieldset><br>

        <!-- Liste des pbjets. -->
        <fieldset>
            <legend>Sélectionner zéro, un ou plusieurs objets :</legend>
            <div id="objetList"></div>
        </fieldset><br>

        <button type="submit">Mise jour du dresseur</button>
    </form>

    <div id="result"></div>         <!-- Zone où on affichera dynamiquement les données enregistrées. -->

    
<script>
    const params = new URLSearchParams(window.location.search);
    const dresseurId = params.get('id'); 

    // Absence de l'identifiant dans l'URL
    if (!dresseurId) {
        document.getElementById('result').innerText = "Erreur : Aucun ID fourni dans l'URL";
        throw new Error("Aucun ID fourni dans l'URL");
    }

    // Fonction générique pour afficher une liste de cases à cocher.
        // container : la <div> où on va mettre les cases à cocher
        // items : tableau reçu de l’API
        // nameAttr : le nom à attribuer à chaque checkbox (ex : "pokemons", "objets")
        // labelField : nom du champ à afficher (ex : "nom")
    function renderCheckboxList(container, items, nameAttr, labelField) {
        container.innerHTML = '';                                               // Vide la div avant d'ajouter les nouvelles cases.
        items.forEach(it => {
            // Création d'une checkbox pour chaque élément.
            const label = document.createElement('label');                      // Créer un élément HTML <label> qui permettent un affichage propre et un clic plus facile sur la checkbox.
            
            const cb = document.createElement('input');                         // Créer une checbox
            cb.type = 'checkbox';                                               // Définit le type de l’input : une case à cocher.
            cb.name = nameAttr;                                                 // Donne un nom commun à toutes les cases.
            cb.value = it._id;                                                  // La valeur envoyée au serveur sera l’ID MongoDB de l’objet.

            label.appendChild(cb);                                              // Mettre la checkbox à l’intérieur du <label>.
            label.appendChild(document.createTextNode(" " + it[labelField]));   // Ajouter le texte à afficher à côté de la case.
                                                    // " " + ... ajoute un espace avant.
                                                    // it[labelField] récupère la valeur du champs donné (ici: "nom").
            container.appendChild(label);                                       // Ajouter le <label> complet dans la div (container).
            container.appendChild(document.createElement('br'));                // Ajouter un saut de ligne
        });
    }

    async function afficherNomsPokemons(listeCaptures) {
        const noms = [];

        for (const capture of listeCaptures) {
            const pokemonId = capture.pokemon;                                                  // Récupérer l'id du pokémon

            // Récupération du Pokémon par son ID
            const response = await fetch(`http://localhost:3000/api/pokemons/${pokemonId}`);    // Rechercher les données correspndantes à l'id donnée
            const pokemon = await response.json();

            noms.push(pokemon.nom);   // On récupère le NOM
        }

        // Affichage
        document.getElementById('pokemons').value = noms.join(", ");
    }


    // Chargement des données demandées
    async function dresseurLoad() {
        try {
            // Recherche, traduction et stokage des données 
            const response = await fetch(`http://localhost:3000/api/dresseurs/${dresseurId}`);
            const dresseur = await response.json();

            // Gestion des données vides ou invalides
            if (!dresseur || dresseur.error) {
                document.getElementById('result').innerText = "Erreur : Le dresseur demandé n'a pas pu étre chargé ou n'existe pas";
                return;
            }

            // Répartition des données dans des variables
            document.getElementById('nom').value = dresseur.nom;


        } catch (error) {
            console.error(error);
        }
    }
