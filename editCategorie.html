<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Modifier une catégorie</title>
</head>
<body>

<h2>Modifier une catégorie</h2>

<form id="categorieForm">
    <label>Nom :</label><br>
    <input type="text" id="nom" required><br><br>

    <button type="submit">Mettre à jour la catégorie</button>
</form>

<div id="result"></div>

<script>
    const params = new URLSearchParams(window.location.search);
    const categorieId = params.get('id'); // Permet de récupérer l'ID de la catégorie au niveau de l'URL sous le format : ?id=<id>

    // Ici on s'assure que l'utilisateur a fourni un ID dans l'URL
    // S'il n'a pas fourni un ID, on affiche un message d'erreur
    if (!categorieId) {
        document.getElementById('result').innerText = "Erreur : Aucun ID fourni dans l'URL";
        throw new Error("Aucun ID fourni dans l'URL");
    }

    // Ici on charge les données de la catégorie demandée
    async function loadCategorie() {
        try {
            // On cherche la catégorie demandée et stocke les données dans la variable "categorie"
            const response = await fetch(`http://localhost:3000/api/categories/${categorieId}`);
            const categorie = await response.json();

            // Ici on s'assure que la catégorie demandée a pu étre chargée ou qu'elle existe bien
            // Si ce n'est pas le cas, on affiche un message d'erreur
            if (!categorie || categorie.error) {
                document.getElementById('result').innerText = "Erreur : La catégorie demandée n'a pas pu étre chargée ou la catégorie n'existe pas";
                return;
            }

            // Ici on récupère les données de la catégorie et
            // on les met dans les champs du formulaire
            document.getElementById('nom').value = categorie.nom;

        } catch (error) {
            console.error(error);
        }
    }

    // Ici on appelle la fonction qui charge les données de la catégorie
    loadCategorie();

    // Ici on récupère les données du formulaire
    const form = document.getElementById('categorieForm');

    // Ici on ajoute un gestionnaire d'événement au formulaire
    // On vérifie si l'utilisateur a appuyé sur le bouton "Mettre à jour la catégorie"
    form.addEventListener('submit', async (e) => {
        e.preventDefault(); // On utilise preventDefault() pour empecher le rechargement de la page

        // On reconstruit un objet de type categorie avec les données du formulaire
        const data = {
            nom: document.getElementById('nom').value,
        };

        // Ici on envoie la requête au serveur en utilisant fetch en utilisant la methode PUT
        try {
            const response = await fetch(`http://localhost:3000/api/categories/${categorieId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            // Ici on récupère la réponse du serveur
            const result = await response.json();

            // Ici on affiche la réponse du serveur sous forme de texte
            document.getElementById('result').innerText =
                "catégorie mise à jour : " + JSON.stringify(result, null, 2);

        } catch (error) {
            console.error(error);
        }
    });

</script>

</body>
</html>
