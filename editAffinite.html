<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Modifier une affinité</title>
</head>
<body>

<h2>Modifier une affinité</h2>

<form id="affiniteForm">
    <label>Nom :</label><br>
    <input type="text" id="nom" required><br><br>

    <label>Description :</label><br>
    <input type="text" id="description" required><br><br>

    <button type="submit">Mettre à jour l'affinité</button>
</form>

<div id="result"></div>

<script>
    const params = new URLSearchParams(window.location.search);
    const affiniteId = params.get('id'); // Permet de récupérer l'ID de la affinite au niveau de l'URL sous le format : ?id=<id>

    // Ici on s'assure que l'utilisateur a fourni un ID dans l'URL
    // S'il n'a pas fourni un ID, on affiche un message d'erreur
    if (!affiniteId) {
        document.getElementById('result').innerText = "Erreur : Aucun ID fourni dans l'URL";
        throw new Error("Aucun ID fourni dans l'URL");
    }

    // Ici on charge les données de  affinite demandée
    async function loadAffinite() {
        try {
            // On cherche la affinite demandée et stocke les données dans la variable "affinite"
            const response = await fetch(`http://localhost:3000/api/affinites/${affiniteId}`);
            const affinite = await response.json();

            // Ici on s'assure que la affinite demandée a pu étre chargée ou qu'elle existe bien
            // Si ce n'est pas le cas, on affiche un message d'erreur
            if (!affinite || affinite.error) {
                document.getElementById('result').innerText = "Erreur : L'affinité demandée n'a pas pu étre chargée ou l'affinité n'existe pas";
                return;
            }

            // Ici on récupère les données de la affinite et
            // on les met dans les champs du formulaire
            document.getElementById('nom').value = affinite.nom;
            document.getElementById('description').value = affinite.description;

        } catch (error) {
            console.error(error);
        }
    }

    // Ici on appelle la fonction qui charge les données de la affinite
    loadAffinite();

    // Ici on récupère les données du formulaire
    const form = document.getElementById('affiniteForm');

    // Ici on ajoute un gestionnaire d'événement au formulaire
    // On vérifie si l'utilisateur a appuyé sur le bouton "Mettre à jour la affinite"
    form.addEventListener('submit', async (e) => {
        e.preventDefault(); // On utilise preventDefault() pour empecher le rechargement de la page

        // On reconstruit un objet de type affinite avec les données du formulaire
        const data = {
            nom: document.getElementById('nom').value,
            description: document.getElementById('description').value,
        };

        // Ici on envoie la requête au serveur en utilisant fetch en utilisant la methode PUT
        try {
            const response = await fetch(`http://localhost:3000/api/affinites/${affiniteId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            // Ici on récupère la réponse du serveur
            const result = await response.json();

            // Ici on affiche la réponse du serveur sous forme de texte
            document.getElementById('result').innerText =
                "Affinité mise à jour : " + JSON.stringify(result, null, 2);

        } catch (error) {
            console.error(error);
        }
    });

</script>

</body>
</html>
