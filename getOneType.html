<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Détails du type</title>
        <!-- Charger la bibliothèque d’icônes Font Awesome depuis un CDN (Cloudflare), 
             Avec vérification de sécurité (SRI) (integrity)
             Sans fuite de données (referrer + crossorigin)  -->
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
        integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="   
        crossorigin="anonymous" referrerpolicy="no-referrer" />

    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div id="toastContainer"></div>

    <div class="page-header">
        <h2>Détails du type</h2>

        <div class="header-actions">
            <button class="back-btn" onclick="window.location.href='getTypeList.html'">
                <i class="fa-solid fa-arrow-left"></i>
                Retour à la liste
            </button>
            <button class="edit-btn" id="editBtn">
                <i class="fa-regular fa-pen-to-square"></i>
                Modifier
            </button>
        </div>
    </div>

    <div class="card">
        <div class="field-label">Nom</div>
        <div class="field-value" id="nameValue">Chargement...</div>

        <div class="field-label">Affinités</div>
        <div class="field-value">
            <ul id="subclassList">
                <li>Chargement...</li>
            </ul>
        </div>
    </div>

    <div id="message"></div>

    <script>
        const API_BASE_URL = 'http://localhost:3000/api/types';

        const pageModifier = "editType.html";

        const nameValue  = document.getElementById('nameValue');
        const subclassList = document.getElementById('subclassList');
        const editBtn    = document.getElementById('editBtn');

        const messageImpossible = "Impossible de charger ce type.";
        const messageVide = "Aucune affinité associée.";

        const params = new URLSearchParams(window.location.search);
        const dataId= params.get('id');

        /**
         * Affiche un message de type toast (succès ou erreur)
         * @param {string} message - Le message à afficher
         * @param {string} [type="success"] - Le type du message (succès ou erreur)
         */
        function showToast(message, type = "success") {
            const container = document.getElementById("toastContainer");
            const toast = document.createElement("div");

            toast.className = "toast";
            if (type === "error") toast.classList.add("error");

            toast.textContent = message;
            container.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, 5000);
        }

        // Vérification qu'une ID est bien fournie dans l'URL
        if (!dataId) {
            showToast("Aucun ID fourni dans l'URL.", "error");
            nameValue.textContent  = '-';
            subclassList.innerHTML = '<li>-</li>';
            descriptionValue.textContent = '-';
            editBtn.disabled = true;
        } else {
            editBtn.addEventListener('click', () => {
                window.location.href = `${pageModifier}?id=${dataId}`;
            });

            loadData();
        }

        /**
         * Charge les données depuis le serveur et l'affiche dans la page.
         * En cas d'erreur, un message d'erreur est affiché et les valeurs sont
         * initialisées à "-".
         */
        async function loadData() {
            try {
                const dataResponse = await fetch(`${API_BASE_URL}/${dataId}`);
                const dataJson = await dataResponse.json();

                if (!dataResponse.ok || !dataJson) {
                    showToast(messageImpossible, "error");
                    nameValue.textContent  = '-';
                    subclassList.innerHTML = '<li>-</li>';
                    return;
                }

                nameValue.textContent  = dataJson.nom  ?? '-';
                subclassList.innerHTML = '';

            if (Array.isArray(dataJson.affinites) && dataJson.affinites.length > 0) {
                dataJson.affinites.forEach(c => {
                    const li = document.createElement('li');
                    if (c && typeof c === 'object') {
                        li.textContent = `${c.nom || 'affinité'} (${c.description || 'description'})`;
                    } else {
                        li.textContent = c;
                    }
                    subclassList.appendChild(li);
                });
            } else {
                subclassList.innerHTML = `<li>${messageVide}</li>`;
            }

        } catch (error) {
            console.error(error);
            showToast("Erreur lors du chargement", "error");
                nameValue.textContent  = '-';
                subclassList.innerHTML = '<li>-</li>';
                descriptionValue.textContent = '-';
            }
        }
    </script>

</body>
</html>
