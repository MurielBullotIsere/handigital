<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Créer un dresseur</title>
        <!-- Charger la bibliothèque d’icônes Font Awesome depuis un CDN (Cloudflare), 
             Avec vérification de sécurité (SRI) (integrity)
             Sans fuite de données (referrer + crossorigin)  -->
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
        integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="   
        crossorigin="anonymous" referrerpolicy="no-referrer" />

    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="toastContainer"></div>

    <div class="page-header">
        <h2>Créer un dresseur</h2>

        <button class="back-btn" onclick="window.location.href='getDresseurs.html'">
            <i class="fa-solid fa-arrow-left"></i>
            Retour à la liste
        </button>
    </div>

    <div class="card">
        <form id="dresseurForm">
            <div class="form-group">
                <label for="name">Nom :</label>
                <input type="text" id="nom" required>
            </div>

            <div class="form-group">
                <label>Pokémons capturés :</label>
                <div class="inline-group">
                    <select id="pokemonSelect">
                        <option value="">-- Choisir un pokémon --</option>
                    </select>
                    <button type="button" class="add-pokemon-btn" id="addPokemonBtn">
                        <i class="fa-solid fa-plus"></i>
                        Ajouter
                    </button>
                </div>
                <small>Vous pouvez ajouter plusieurs fois le même pokémon.</small>

                <ul id="selectedPokemonList">
                    <li>Aucun pokémon sélectionné pour l'instant.</li>
                </ul>
            </div>

            <div class="form-group">
                <label>Objets :</label>
                <div class="inline-group">
                    <select id="objetSelect">
                        <option value="">-- Choisir un objet --</option>
                    </select>
                    <button type="button" class="add-objet-btn" id="addObjetBtn">
                        <i class="fa-solid fa-plus"></i>
                        Ajouter
                    </button>
                </div>
                <small>Vous pouvez ajouter plusieurs fois le même objet.</small>

                <ul id="selectedObjetList">
                    <li>Aucun objet sélectionné pour l'instant.</li>
                </ul>
            </div>

            <button type="submit" class="submit-btn">
                <i class="fa-solid fa-plus"></i>
                Créer
            </button>
        </form>
    </div>

    <script>
        const API_DRESSEURS = 'http://localhost:3000/api/dresseurs';
        const API_POKEMONS = 'http://localhost:3000/api/pokemons';
        const API_OBJETS = 'http://localhost:3000/api/objets';

        // Récupération du formulaire.
        const form = document.getElementById('dresseurForm');
        const pokemonSelect = document.getElementById('pokemonSelect');
        const addPokemonBtn = document.getElementById('addPokemonBtn');
        const selectedPokemonList = document.getElementById('selectedPokemonList');
        const objetSelect = document.getElementById('objetSelect');
        const addObjetBtn = document.getElementById('addObjetBtn');
        const selectedObjetList = document.getElementById('selectedObjetList');

        /**
         * Affiche un message de type toast (succès ou erreur)
         * @param {string} message - Le message à afficher
         * @param {string} [type="success"] - Le type du message (succès ou erreur)
         */
        function showToast(message, type = "success") {
            const container = document.getElementById("toastContainer");        // Indication de l'emplacement <div> qui servira de conteneur pour les notifications.
            const toast = document.createElement("div");                        // Création dynamique d'un nouvel élément <div> qui représentera notre notification.

            toast.className = "toast";                                          // On ajoute la classe "toast" à ce <div>.
            if (type === "error") toast.classList.add("error");                 // Si le type de notification est "error", on ajoute une classe CSS "error" supplémentaire.

            toast.textContent = message;                                        // On met le texte fourni (message) à l’intérieur du <div>.
            container.appendChild(toast);                                       // On ajoute le toast dans le conteneur sur la page pour qu’il devienne visible.

            setTimeout(() => {toast.remove();}, 5000);                          // Suppression automatique du toast après 5000 millisecondes (5 secondes).
        }

/** Première version avant correction par rapport aux fichier createBouquet.html
 *  Dans cette version, on ne peut pas avoir des pokémons et des objets en double
        // Fonction générique pour afficher une liste de cases à cocher.
            // container : la <div> où on va mettre les cases à cocher
            // items : tableau reçu de l’API
            // nameAttr : le nom à attribuer à chaque checkbox (ex : "pokemons", "objets")
            // labelField : nom du champ à afficher (ex : "nom")
        function renderCheckboxList(container, items, nameAttr, labelField) {
            container.innerHTML = '';                                               // Vide la div avant d'ajouter les nouvelles cases.
            items.forEach(it => {
                // Création d'une checkbox pour chaque élément.
                const label = document.createElement('label');                      // Créer un élément HTML <label> qui permettent un affichage propre et un clic plus facile sur la checkbox.
                
                const cb = document.createElement('input');                         // Créer une checbox
                cb.type = 'checkbox';                                               // Définit le type de l’input : une case à cocher.
                cb.name = nameAttr;                                                 // Donne un nom commun à toutes les cases.
                cb.value = it._id;                                                  // La valeur envoyée au serveur sera l’ID MongoDB de l’objet.

                label.appendChild(cb);                                              // Mettre la checkbox à l’intérieur du <label>.
                label.appendChild(document.createTextNode(" " + it[labelField]));   // Ajouter le texte à afficher à côté de la case.
                                                       // " " + ... ajoute un espace avant.
                                                       // it[labelField] récupère la valeur du champs donné (ici: "nom").
                container.appendChild(label);                                       // Ajouter le <label> complet dans la div (container).
                container.appendChild(document.createElement('br'));                // Ajouter un saut de ligne
            });
        }


        // Fonction déclarée comme async : utilisation de await à l’intérieur pour gérer des opérations asynchrones (fetch HTTP).
        // Charger les pokémons capturables
        async function loadPokemons() {
            const res = await fetch('http://localhost:3000/api/pokemon');           // Envoyer une requête HTTP GET à API Express
                           // fetch(...) : demander au serveur la liste des Pokémon
                     // await : attendre que la réponse arrive sans bloquer la page
               // res : contient l’objet réponse (pas encore les données !)
            const pokemons = await res.json();                                      // Transformer la réponse en JSON
            renderCheckboxList(
                document.getElementById('pokemonList'),     // La <div> où afficher les checkbox.
                pokemons,                                   // Les données reçues depuis l’API.
                'pokemon',                                  // Le nom donné à chaque champ checkbox.
                'nom'                                       // Le champ affiché dans le label.
            );
        }

        // Charger les objets 
        async function loadObjets() {
            const res = await fetch('http://localhost:3000/api/objets');
            const objets = await res.json();
            renderCheckboxList(
                document.getElementById('objetList'), 
                objets, 
                'objet', 
                'nom'
            );
        }
*/

        // Sélectionner toutes les cases cochées.
            // querySelectorAll...) retourne une NodeList, pas un tableau.
            // querySelectorAll(...) sélectionne tous les éléments HTML qui correspondent au sélecteur CSS.
            // le sélecteur est :
                // input[name="..."]:checked  :  tous les <input> ayant un attribut name et qui sont cochés (:checked)
        function collectChecked(name) {
            // Array.from() transforme une NodeList en vrai tableau JavaScript.
            return Array.from(document.querySelectorAll(`input[name="${name}"]:checked`))
                .map(i => i.value);             // Pour chaque case cochée (i), on récupère sa valeur (value = _id).
        }


        // Charger les données au chargement de la page
        loadPokemons();
        loadObjets();

        form.addEventListener('submit', async (e) => {
            e.preventDefault(); // On utilise preventDefault() pour empecher le rechargement de la page afin d'afficher les données intégrées

            // Reconstruction d'un objet de type Dresseur avec les données du formulaire
            const data = {
                nom: document.getElementById('nom').value,
                // Récupérer toutes les cases cochées portant le name="pokemon".
                // .map(...) : transformer chaque ID en un objet complet [{ pokemon: "675ab12", team: false }, ...]
                Pokemon_captures: collectChecked('pokemon').map(
                    p => ({
                        pokemon: p,
                        team: false     // Aucun Pokémon n’est encore dans l’équipe.
                    })
                ),
                // Récupérer toutes les cases cochées portant le name="objet".
                objets: collectChecked('objet')            
            };

            // Ici on envoie la requête au serveur en utilisant fetch
            // On utilise la methode POST car on veut créer un nouveau dresseur
            try {
                const response = await fetch('http://localhost:3000/api/dresseurs', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },        // Le header indique au serveur que ce qu'il envoie est du JSON.
                    body: JSON.stringify(data)                              // JSON.stringify() convertit l’objet en texte JSON.
                });

                // response.json() lit le corps de la réponse et le convertit depuis du JSON vers un objet JavaScript.
                // result devient un objet JS.
                const result = await response.json();

                // Mettre du texte dans la <div id="result"></div> de la page HTML.
                document.getElementById('result').innerText =
                    "Réponse serveur : " + JSON.stringify(result, null, 2);     
                                                               // null : on n’utilise pas de fonction de transformation
                                                                     // 2 : indentation pour rendre le JSON lisible
            } catch (error) {
                console.error("Erreur :", error);
            }
        });
    </script>

</body>
</html>