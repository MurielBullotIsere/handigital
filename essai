<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Modifier un objet</title>

    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
          integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
          crossorigin="anonymous"
          referrerpolicy="no-referrer" />

    <link rel="stylesheet" href="style.css">
</head>

<body>

<div id="toastContainer"></div>

<div class="page-header">
    <h2>Modifier un objet</h2>

    <button class="back-btn" onclick="window.location.href='getObjectList.html'">
        <i class="fa-solid fa-arrow-left"></i>
        Retour à la liste
    </button>
</div>

<div class="card">
    <form id="componentForm">
        <div class="form-group">
            <label for="nom">Nom :</label>
            <input type="text" id="nom" required>
        </div>

        <div class="form-group">
            <label>Catégorie de l'objet :</label>
            <div class="inline-group">
                <select id="subclassSelect">
                    <option value="">-- Choisir une catégorie --</option>
                </select>
                <button type="button" class="add-subclass-btn" id="addSubclassBtn">
                    <i class="fa-solid fa-plus"></i>
                    Cliquer pour ajouter
                </button>
            </div>

            <ul id="selectedSubclassList">
                <li>Chargement...</li>
            </ul>
        </div>

        <div class="form-group">
            <label for="description">Description :</label>
            <input type="text" id="description" required>
        </div>
        <button type="submit" class="submit-btn">
            <i class="fa-regular fa-pen-to-square"></i>
            Modifier l'objet
        </button>
    </form>
</div>

<script>
/* ===================== CONFIG ===================== */
const API_BASE_URL = 'http://localhost:3000/api/objets';
const API_SUBCLASS = 'http://localhost:3000/api/categories';

const form = document.getElementById('componentForm');
const subclassSelect = document.getElementById('subclassSelect');
const addSubclassBtn = document.getElementById('addSubclassBtn');
const selectedSubclassList = document.getElementById('selectedSubclassList');

const messageChoisir = "-- Choisir une catégorie --";
const messageErreurSubclass = "Erreur lors du chargement des catégories";
const messageSelection = "Aucune catégorie sélectionnée pour l'instant.";
const messageImpossible = "Impossible de charger cet objet.";
const messageErreurComponent = "Erreur lors du chargement de l'objet";

/* ===================== DATA ===================== */
let allSubclassItem = [];
let selectedAllItemId = [];

/* ===================== TOAST ===================== */
function showToast(message, type = "success") {
    const container = document.getElementById("toastContainer");
    const toast = document.createElement("div");

    toast.className = "toast";
    if (type === "error") toast.classList.add("error");

    toast.textContent = message;
    container.appendChild(toast);

    setTimeout(() => toast.remove(), 5000);
}

/* ===================== URL PARAM ===================== */
const params = new URLSearchParams(window.location.search);
const dataId = params.get('id');

if (!dataId) {
    showToast("Aucun ID fourni dans l'URL.", "error");
    form.style.display = "none";
} else {
    init();
}

/* ===================== INIT ===================== */
async function init() {
    await loadSubclass();
    await loadComponent();
}

/* ===================== LOAD CATEGORIES ===================== */
async function loadSubclass() {
    try {
        const response = await fetch(API_SUBCLASS);
        const data = await response.json();

        allSubclassItem = Array.isArray(data) ? data : [];
        subclassSelect.innerHTML = `<option value="">${messageChoisir}</option>`;

        allSubclassItem.forEach(cat => {
            const option = document.createElement('option');
            option.value = cat._id;
            option.textContent = cat.item1;
            subclassSelect.appendChild(option);
        });

    } catch (error) {
        console.error(error);
        showToast(messageErreurSubclass, "error");
    }
}

/* ===================== SELECTED LIST ===================== */
function refreshSelectedSubclassList() {
    selectedSubclassList.innerHTML = '';

    if (selectedAllItemId.length === 0) {
        selectedSubclassList.innerHTML = `<li>${messageSelection}</li>`;
        return;
    }

    selectedAllItemId.forEach((id, index) => {
        const item = allSubclassItem.find(i => i._id === id);
        const li = document.createElement('li');
        li.className = 'selected-subclass-item';

        const span = document.createElement('span');
        span.textContent = `${index + 1}. ${item ? item.item1 : id}`;

        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'remove-subclass-btn';
        btn.innerHTML = '<i class="fa-solid fa-xmark"></i>';
        btn.onclick = () => removeSubclassEdit(index);

        li.append(span, btn);
        selectedSubclassList.appendChild(li);
    });
}

function removeSubclassEdit(index) {
    selectedAllItemId.splice(index, 1);
    refreshSelectedSubclassList();
}

/* ===================== LOAD OBJECT ===================== */
async function loadComponent() {
    try {
        const response = await fetch(`${API_BASE_URL}/${dataId}`);
        const component = await response.json();

        if (!response.ok || !component) {
            showToast(messageImpossible, "error");
            form.style.display = "none";
            return;
        }

        document.getElementById('nom').value = component.item1 || '';
        document.getElementById('description').value = component.item2 || '';

        if (Array.isArray(component.categorie)) {
            selectedAllItemId = component.categorie.map(c =>
                typeof c === 'object' ? c._id : c
            );
        }

        refreshSelectedSubclassList();

    } catch (error) {
        console.error(error);
        showToast(messageErreurComponent, "error");
        form.style.display = "none";
    }
}
</script>

</body>
</html>
